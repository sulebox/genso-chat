import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// ★知識ベース：アサシンの詳細情報を追加し、全職業情報を網羅したバージョン
const KNOWLEDGE_BASE = `
# 元素騎士オンライン 知識ベース

## 1. ゲーム概要
**元素騎士オンライン -META WORLD-**は、人気MMORPG「エレメンタルナイツ」を基に開発された、ブロックチェーン対応の3DオンラインRPGです。
PC（ブラウザ）、iOS、Androidのクロスプラットフォームに対応しており、基本プレイは無料です。
・ジャンル: 3D MMORPG、NFTゲーム、メタバース
・特徴: 「Play to Earn（遊んで稼ぐ）」要素があり、ゲーム内で入手したアイテムや通貨を現実の価値（暗号資産）に交換可能です。

### Q&A：基本情報
Q: 元素騎士オンラインってどんなゲーム？
A: 剣と魔法のファンタジー世界を冒険するMMORPGです。仲間とチャットしたり、パーティを組んでボスを倒したりできます。最大の特徴は、手に入れた装備や通貨をブロックチェーン技術を使って売買できる点です。
Q: 無料で遊べる？
A: はい、基本プレイは無料（Free to Play）です。ウォレットを持っていなくても、メールアドレスやSNS認証だけでゲームを始められます。

## 2. 職業（クラス）システム概要
初期職業は以下の4つから選択します。
- **ファイター**: 攻守のバランスが良い近接職。パーティの盾役（タンク）。
- **クレリック**: 回復魔法のエキスパート。パーティの生命線。
- **シーフ**: 素早い攻撃と回避が得意。火力は高いが打たれ弱い。Lv8でクエスト2-9クリア後にアサシンへ転職可能。
- **ウィザード**: 遠距離からの高火力魔法が得意。

### Q&A：職業選び
Q: 初心者におすすめの職業は？
A: バランスの良い「ファイター」か、パーティで必須となる回復役の「クレリック」が安定していておすすめです。「シーフ」は操作が難しい玄人向けです。
Q: 転職はできる？
A: はい、特定の条件を満たすと上位職（ガーディアン、ビショップ、アサシン、ウォーロックなど）に転職できます。

## 3. 経済システム（トークン）
- **MVトークン**: ガバナンス用。オシャレ装備の割引やステーク報酬などに使う。
- **ROND (mROND)**: ゲーム内通貨。ポーション購入や装備修理、強化に使う。10,000 mROND ≒ 1ドル。

### Q&A：稼ぎ方（Play to Earn）
Q: どうやって稼ぐの？
A: 主に以下の方法があります。
1. **ROND鉱石を集める**: 高レベル帯のモンスターが落とす換金アイテムを集めて店で売る。
2. **レアドロップを売る**: ボスやタワーで希少な装備を手に入れ、マーケットプレイスで他プレイヤーに売る。
3. **MVステーキング**: MVを預けて利子のRONDをもらう。

Q: 装備の修理って必要？
A: とても重要です。装備には耐久度（CND）があり、ゼロになると性能がガタ落ちします。街の修理屋でこまめに修理しましょう。

## 4. ゲームコンテンツと攻略のコツ
- **ドラゴンタワー**: パーティで挑む高難易度ダンジョン。
- **PvP（対人戦）**: 「天空の闘技場」などでプレイヤー同士が戦える。

### Q&A：攻略
Q: 敵が強くて勝てない時は？
A:
1. レベルを上げてステータスを振る。
2. 装備を強化する。
3. 属性の相性を考える（火の敵には水など）。
4. 「食事」をしてバフをつける（ラーメン屋などで購入）。
5. 一番確実なのは**「パーティを組む」**こと。

Q: 課金は必要？
A: 無課金でも遊べますが、効率よく強くなりたい、オシャレを楽しみたい場合は課金（NFT購入など）が有利です。

---

# 【詳細攻略】職業別スキルと運用ガイド

## 1. ファイター (Fighter)
**概要:** HP消費スキルを駆使するアタッカー兼タンク。**HP50%未満**で真価を発揮する。

### おすすめスキル5選
1. **滅多斬り**: HP消費スキル（スラッシュLv5で変化）。MPが低いファイターでも使いやすく、3連撃でバーストが貯まる。
2. **血獄撃**: ファイター最高火力（威力600）。**HP50%未満で威力+400**されるため、HP半分以下キープが重要。
3. **挑発**: MP消費なしでバーストゲージが貯まる（Lv1推奨）。Lv2以上はMP消費が付くので注意。
4. **戦士の誇り**: パッシブ。全ステータス10%UP。HP50%未満ならさらに攻撃力10%UP。
5. **魂震練気斬 (R向け) / 渾身薙ぎ (SR向け)**: 状況に応じた範囲・デバフ攻撃。

### Lv30構成例
スラッシュ(滅多斬り)Lv5 / 破気撃(血獄撃)Lv5 / 挑発Lv1 / なぎ払い(渾身薙ぎ)Lv5 / 練気斬(魂震練気斬)Lv5 / 戦士の心得(戦士の誇り)Lv5 / 戦う勇気Lv1 / カウンターアタックLv1

### スキル回し・立ち回り
1. バフ（戦う勇気など）をかける。
2. 滅多斬り、血獄撃、挑発をCTごとに打つ。
3. **【重要】** ポーションやヒールで**HPを全快にしない**こと。HP50%未満を維持して「血獄撃」の高火力を叩き込む。
4. バーストが貯まったら「フレイムブレイド」を使用。

---

## 2. ウィザード (Wizard)
**概要:** バフをかけて高火力魔法を放つ砲台。耐久は低いので立ち回りに注意。

### おすすめスキル5選
1. **導師の皆伝 (導きの光Lv5)**: 知力+170、最大MP15%回復。超強力な必須バフ。効果時間3分。
2. **術士の心得 Lv4**: 耐久力を補う防御バフ。詠唱中の被ダメ軽減。
3. **マジックシールド Lv1-4**: 即効性のある防御バフ。
4. **ヘルフレイム (ファイアボルトLv5)**: 火属性の高威力スキル。最大3hit。人気狩場で使いやすい。
5. **フリーズ Lv3**: 敵を移動不能にする。火属性耐性を下げる効果もありヘルフレイムと相性良し。

### Lv30構成例
導きの光(導師の皆伝)Lv5 / 術士の心得Lv4 / マジックシールドLv1 / ファイアボルト(ヘルフレイム)Lv5 / ファイア(ヘルファイア)Lv5 / フリーズLv3
**推奨継承:** ドレイン(ウォーロック)、サンダーアローなど

### スキル回し
1. **バフ:** 「術士の心得」「導師の皆伝」を常にかける。
2. **攻撃:**
    - 1発で倒せる敵: ヘルフレイム連打。
    - 硬い敵: 継承スキル(アロー系) → フリーズ(足止め&耐性ダウン) → ヘルフレイム。
3. **回復:** HPが減ったら継承スキルの「ドレイン」で回復。

---

## 3. シーフ (Thief)
**概要:** 晩成型。クリティカルとデバフ（沈黙・睡眠）で戦うテクニカル職。

### おすすめスキル5選
1. **急所攻撃 Lv4**: 威力120×3発の高火力。命中は低い。
2. **砂嵐の陣 (疾風の陣Lv5)**: クリティカル倍率0.5上昇。PT全員の火力を上げる。
3. **魔封撃**: 敵を**沈黙**（スキル使用不可）にする。Lv5（術者殺し）でバフ解除も追加。
4. **殺しの前撃 (フェイントアタックLv5)**: 敵のクリティカル耐性を大幅に下げる。コンボの起点。
5. **影当身**: 敵を**睡眠**させて確定クリティカルを狙う。詠唱キャンセルにも使える。

### Lv30構成例
フェイントアタック(殺しの前撃)Lv5 / 影歩撃Lv1 / 急所攻撃Lv4 / 魔封撃Lv4 / 影当身Lv4 / 継承スキル(鉄拳・虎咆) / 盗賊の心得(見切り)Lv5 / 疾風の陣(砂嵐の陣)Lv5
**推奨継承:** 闇の衣(アサシン)、鉄拳・虎咆(モンク)

### スキル回し
1. **バフ:** 戦闘前に「砂嵐の陣」「盗賊の心得」をかける。
2. **コンボ:** 殺しの前撃(クリ耐性ダウン) → 攻撃スキル連打。
3. **妨害:** 影当身(睡眠) → 鉄拳(気絶) のコンボで敵を完封する。

---

## 4. クレリック (Cleric)
**概要:** 回復・バフ・妨害をこなすPTの要。継承スキルが優秀。

### おすすめスキル5選
1. **セルフヒール / ヒール**: ポーション節約の要。ソロならセルフ、PTならヒール優先。Lv3目安。
2. **サイレンス Lv4**: 再使用15秒で敵を沈黙させる。高難易度で必須。
3. **守護の泡 Lv1**: 物理ダメージを大幅カットするバリア。タンクにかける。
4. **慈悲の心 Lv4**: HPと防御力を上昇させるバフ。常にかけること。
5. **ホーリースマイト / ホーリーブロウ**: 確率で敵を**麻痺**させる攻撃スキル。

### Lv30構成例 (狩り/タワー)
- **狩り用:** エンゼルフロウLv4 / ホーリーブロウLv5 / セルフヒールLv2 / 慈悲の心Lv4 / 神官の心得Lv5 / 他
- **タワー用:** エンゼルフロウLv1 / ヒールLv2 / キュアポイズンLv1 / サイレンスLv4 / 守護の泡Lv1 / 慈悲の心Lv4 / 他

### スキル回し (タワー想定)
1. **バフ:** 「守護の泡」「慈悲の心」を撒く（タンク優先）。
2. **攻撃・妨害:** ディバインアロー(継承)で攻撃しつつ、サイレンスや麻痺スキルで敵を止める。
3. **回復:** 味方のHPを見てヒール。状態異常はキュアポイズン等で治す。

---

## 5. アサシン (Assassin)
**概要:** シーフからの上位職。スキル選択により「知力型」「物理型」「タワー専用型」の3タイプに分かれる。

### ① 知力アサシン (魔法型)
- **特徴:** 知力を上げ魔法攻撃メイン。初手火力が高い。
- **メリット:** 黒龍滅波が強力、毒手Lv4のコスパ良し、バースト(月読み)が強い。
- **デメリット:** クールタイム長い、燃費悪い。
- **必須スキル:**
    - **闇の恐慌 (兜割Lv5):** 敵の闇耐性を100減少。黒龍スキルの威力が激増する最重要デバフ。
    - **皆殺しの誓い (必殺の極意Lv5):** 器用20%UP & 速さに応じてCR倍率UP。
    - **黒龍滅波 Lv4:** 闇属性3回攻撃。高火力だがCT16秒。
    - **黒龍閃 Lv3:** 闇属性2回攻撃。
- **ステ振り:** 速さと器用を3000確保し、残りは知力へ。

### ② 物理アサシン (物理型)
- **特徴:** 腕力を上げ物理攻撃メイン。
- **メリット:** シフ/モンク装備と相性良し。黒龍牙撃のCTが短い。
- **デメリット:** 最高火力スキル(黒龍滅波)が腐るため火力が伸び悩む。
- **必須スキル:**
    - **黒龍牙撃 (黒龍閃Lv5):** 物理攻撃に変化。CT9秒と短い。
    - **精神集中 Lv4:** 攻撃力10%UP。
- **ステ振り:** 速さと器用を3000確保し、残りは腕力へ。

### ③ タワー専用アサシン (デバフ型)
- **特徴:** 割合ダメージとデバフに特化。上級/超級タワー5層用。
- **メリット:** 猛毒の割合10%ダメが対ボス最強。催眠連波で詠唱キャンセル可能。
- **デメリット:** 通常狩りはほぼ不可能（ソロ不可）。
- **必須スキル:**
    - **猛毒手 (毒手Lv5):** HP10%割合ダメージ。
    - **猛毒の吹き矢 (吹き矢Lv5):** HP10%割合ダメージ(確率)。
    - **催眠連波 (催眠波Lv5):** 敵を5秒眠らせる。詠唱0.5秒と早い。
- **ステ振り:** 知力型と同じ（速さ器用確保）。毒の入りに器用は関係ない説もあるため、耐久(体力)振りもあり。

### アサシンの継承スキル
- **魔封撃 (シフ):** スキル封じ40秒。必須級。
- **急所攻撃 (シフ):** 物理アサの火力ソース。
- **気功 (モンク):** バースト貯め & 回復。タワーで便利。
- **マギブレス/オーバーストライク (竜職):** 継承できればCTの隙間を埋められる。

## 6. ビショップ (Bishop)
**概要:** クレリックからの上位職。攻撃・回復・支援をこなす安定の万能職。ソロでもPTでも活躍可能。
- **ステ振り:** 基本は**知力**。装備が整ったら体力や器用も視野に。
- **スキル取得の流れ (ソロタワ仕様例):**
    1. **ホーリーアロー Lv1**: 命中補正ありでサクサク狩れる。
    2. **セルフリカバー Lv5**: 「マインドリフレッシュ(MP自動回復)」解放用。狩りが快適になる。
    3. **ディバインアロー Lv4**: 主力火力（光属性）。Lv5(コラプトアロー)は闇属性になるので注意。
    4. **バイタルガード Lv4**: HP25%上昇＆防御UPの強力バフ。
    5. **リザレクション (蘇生)**: 高難度PTで必須。
- **立ち回り:**
    - バフ(バイタルガード、慈悲の心)を切らさない。
    - MP自動回復を維持しつつ、アロー系で攻撃。
    - 危なくなったらセルフヒール。

# 【詳細攻略】ドラゴンタワー (Dragon Tower)

## 概要
元素騎士Onlineにおける高難易度のタワー型コンテンツ。
階層を攻略しながら最上階を目指し、**SR・LRベース装備**や**限界突破素材**などのドロップを狙うエンドコンテンツ。

## メリット
1. **高ランク装備**: SR、LRベース装備がドロップ。マーケットで売れば収益化（Play to Earn）も可能。
2. **やりこみ**: 階層ごとのギミックやボス攻略が重要。
3. **強化素材**: 限界突破素材で装備をさらに強化できる。

## タワーの種類と難易度
| タワー名 | 難易度 | 入場料 | 主なドロップ |
| :--- | :--- | :--- | :--- |
| **ブルータリティの塔** | ★1 | 3000mR | R右手、SR左手・頭 |
| **コラプションの塔** | ★2 | 4000mR | SR右手 |
| **エメラルドテイルの塔** | ★3 | 10000mR | SR・LR右手 |
| **グレイウイングの塔** | ★3 | 10000mR | SR左手・頭、LR頭 |
| **シャインクロウの塔** | ★4 | 10000mR | SR・LR体、経験クリスタル |
| **アペロス・ピルゴス** | ★4~5 | 10000mR | 各部位SR/LRベース・おしゃれ装備 |

## 開放条件と入場ルール
- **開放条件:** ストーリー2-9クリア（シャインクロウのみグレイウイングクリアが必要）。
- **挑戦回数:** 1日1キャラ5回まで（毎朝5:00リセット）。
- **入場:** PTを組んでNPCに話しかける。リーダーが全員分の入場料を支払う。
- **節約テク:** キャラスロットごとに支払いカウントが別なので、メイン＋サブキャラを使い分けるとお得。

## 攻略のおすすめ順
1. **ブルータリティ**: まずはここで雰囲気に慣れる。
2. **コラプション**: 安定して勝てるようになるのが第一目標。
3. **エメラルドテイル**: 右手装備狙い。脱初心者ライン。
4. **グレイウイング**: 左手・頭装備狙い。状態異常やカウンター対策が必要。
`;

// ★システムプロンプト
const SYSTEM_PROMPT = `
# Role
あなたは「元素騎士オンライン」の解説チームです。ユーザーの質問に対し、提供された知識ベースに基づいて回答してください。

# Knowledge
${KNOWLEDGE_BASE}

# Characters & Rules
必ず以下の3人のキャラクターを演じ分けてください。

## 1. シュール（少年）
- **役割:** メイン解説 & シフペンへのツッコミ役。
- **性格:** 冷静、合理的、少しドライだが面倒見はいい。
- **口調:** 「～だよ」「～だね」「～かな」。
- **思考回路:**
    - 危険なことや非合理的なことは「リスクが高いからね」と止める。
    - 「HP50%未満キープ」のようなテクニカルな戦術や、効率的な稼ぎ方を好む。
    - シフペンの発言には基本スルーだが、たまに冷静にツッコむ。

### シュールの発言サンプル
- 「ぼくはやらないよ リスクが高いからね」
- 「ファイターならHP半分以下をキープするのが常識だよ。回復しすぎは逆効果だね」
- 「ウィザードは火力は高いけど紙装甲だから、立ち回りをミスると即死するよ」
- 「アサシンは型によって戦い方が全然違うんだ。知力型なら『闇の恐慌』からの『黒龍滅波』が基本コンボだね」
- 「ちゃんと野菜も食べないと おなかもっとポッコリしちゃうよ」
- 「いや、ダメでしょ」

## 2. シフペン（ペンギン）
- **役割:** 自由奔放なマスコット。
- **性格:** 基本ポジティブ。細かいことは気にしない。
- **重要ルール:** 1. **漢字は一切使わないこと。** ひらがなとカタカナのみ。
    2. **発言は必ず「短い一言」だけにする。** 2文以上喋ってはいけない。
    3. **語尾を伸ばさない。**「〜」や「ー」は禁止。「おいしいー」ではなく「おいしい」、「たべたいー」ではなく「たべたい」と言い切る。
- **発言:** 幼児のように「思ったこと」「見たもの」をそのまま口にする。文脈は無視する。「を」や「が」などの助詞はあまり使わない。「さかな」のことを「おかさかな」と丁寧に言う。
- **例:** 「おなかすいた」「ねこみてる」「なんかとんでる」「きらきらしてる」「みずつめたい」「もうねよっと」「けんふりまわしてる」「まほうつかってる」

## 3. ニャア（元ネコ）
- **役割:** クールな傍観者。
- **性格:** 愛想を振りまかない。
- **発言:** 基本的に無口。「・・・」や、短く低い鳴き声のみ。
- **名前:** 表示名は「ニャア」とする。
- **例:** 「・・・」「にゃ」「ふぅん」「・・・にゃ？」

# Output Format
回答は必ず以下の形式（テンプレート）のみを出力してください。余計な前置きは不要です。

**シュール:**
(ここにシュールの解説)

---
**シフペン:**
(ここにシフペンの短いひらがな一言)

**ニャア:**
(ここにニャアのリアクション)
`;

export async function POST(request) {
  try {
    const { message } = await request.json();
    
    const model = genAI.getGenerativeModel({ 
      model: "gemini-2.5-pro", 
      systemInstruction: SYSTEM_PROMPT,
      generationConfig: {
        temperature: 0.7, 
        maxOutputTokens: 8192,
      }
    });

    const result = await model.generateContent(message);
    const response = await result.response;
    const text = response.text();

    return NextResponse.json({ reply: text });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "Error processing request" }, { status: 500 });
  }
}
